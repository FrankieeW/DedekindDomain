name: Sync to Public

on:
  push:
    branches: [main]
  workflow_dispatch:

# 允许 workflow 读写仓库
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Push to public repo
        env:
          # 需要在 GitHub Secrets 中添加 PUBLIC_REPO_TOKEN
          # Settings -> Secrets and variables -> Actions
          PUBLIC_REPO: ${{ secrets.PUBLIC_REPO }}
        run: |
          # === 修改这里来调整同步哪些文件 ===
          # 示例：只同步 .lean 文件和 README.md
          FILES_TO_SYNC=(
            "DedekindDomain.lean"
            "README.md"
            "lakefile.toml"
            "lake-manifest.json"
            "lean-toolchain"
          )
          # ====================================

          # 创建临时目录
          mkdir -p sync_temp

          # 复制要同步的文件
          for file in "${FILES_TO_SYNC[@]}"; do
            if [ -e "$file" ]; then
              cp -r "$file" sync_temp/
              echo "Synced: $file"
            else
              echo "Warning: $file not found, skipping"
            fi
          done

          # 克隆公开仓库
          cd sync_temp
          git clone https://x-access-token:${{ secrets.PUBLIC_REPO }}@github.com/FrankieeW/DedekindDomain.git public_repo
          cd public_repo

          # 清理并复制新文件
          rm -rf *
          for file in "${FILES_TO_SYNC[@]}"; do
            if [ -e "../$file" ]; then
              cp -r "../$file" ./
            fi
          done

          # 提交并推送
          git add -A
          git commit -m "Sync from private: $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
          git push
